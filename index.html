<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Calculator Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;

            /* Add theme variables */
            --bg-primary: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --border-color: #e5e7eb;
        }

        /* Add dark mode variables */
        [data-theme='dark'] {
            --bg-primary: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --border-color: #334155;
            --light: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .input-section h2,
        .results-section h2 {
            color: var(--dark);
            margin-bottom: 1.5rem;
        }

        .investment-type {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--light);
        }

        .investment-type h3 {
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .add-btn {
            background: var(--light);
            color: var(--primary);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 1rem;
        }

        .calculate-btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }

        .calculate-btn:hover {
            background: var(--primary-light);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-item {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .summary-item h4 {
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .summary-item p {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .chart-container {
            margin-top: 2rem;
            height: 400px;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .app-container {
                padding: 1rem;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .lumpsum-entry {
            position: relative;
            padding: 1rem;
            border: 1px solid var(--light);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .remove-investment {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .remove-investment:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Add theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Error message styling */
        .error-message {
            background: var(--danger);
            color: var(--white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .error-message h4 {
            margin-bottom: 0.5rem;
        }

        .error-message ul {
            list-style: none;
            padding-left: 0;
        }

        .error-message li {
            margin-bottom: 0.5rem;
        }

        /* Add to existing CSS */
        .progress-bar {
            height: 4px;
            background: var(--light);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-value {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .target-achieved {
            color: var(--success);
            font-weight: 500;
            text-align: right;
            margin-top: 0.5rem;
        }

        /* Add to your existing styles */
        .custom-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .final-balance {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 0.5rem;
            text-align: center;
        }

        .final-balance h4 {
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .final-balance p {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--success);
        }

        /* EMI Calculator Styles */
        .emi-result {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border-radius: 0.5rem;
            text-align: center;
        }

        .emi-result h4 {
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .emi-result p {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .emi-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .emi-breakdown .summary-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .emi-breakdown .summary-item h4 {
            color: var(--gray);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .emi-breakdown .summary-item p {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* SWP Recommendation Styles */
        .recommendation-note {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            border: 1px solid #29b6f6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .recommendation-note p {
            margin: 0;
            color: #01579b;
            font-size: 0.9rem;
        }

        .recommendation-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            transition: background-color 0.2s;
        }

        .recommendation-btn:hover {
            background: var(--primary-light);
        }

        /* Tab Navigation Styles */
        .calculator-tabs {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Advanced Calculator Styles */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .calc-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calc-card h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .calc-result {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-top: 1rem;
        }

        .calc-result h4 {
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .calc-result p {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .result-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .result-item h5 {
            color: var(--gray);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .result-item p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Portfolio Analytics Styles */
        .portfolio-input {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 0.5rem;
        }

        .portfolio-input input {
            padding: 0.5rem;
        }

        .add-asset-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        /* Cash Flow Input Styles */
        .cashflow-input {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--light);
            border-radius: 0.5rem;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Chart Container for Advanced Calculations */
        .advanced-chart {
            height: 300px;
            margin-top: 1rem;
        }

        @media (max-width: 640px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
            
            .calculator-tabs {
                flex-direction: column;
            }
            
            .portfolio-input {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .cashflow-input {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Investment Calculator Pro</h1>
            <p class="subtitle">Comprehensive Investment Analysis & Financial Planning Tools</p>
            
            <!-- Navigation Tabs -->
            <div class="calculator-tabs">
                <button class="tab-btn active" onclick="showTab('investment')">Investment Planner</button>
                <button class="tab-btn" onclick="showTab('advanced')">Advanced Calculations</button>
                <button class="tab-btn" onclick="showTab('portfolio')">Portfolio Analytics</button>
                <button class="tab-btn" onclick="showTab('risk')">Risk Analysis</button>
            </div>
        </header>

        <main>
            <!-- Investment Planner Tab -->
            <div id="investment" class="tab-content active">
                <div class="calculator-grid">
                    <!-- Investment Inputs Section -->
                    <section class="input-section">
                        <div class="card">
                            <h2>Investment Details</h2>
                            <div class="input-group">
                                <label for="annualRate">Annual Return Rate (%)</label>
                                <input type="number" id="annualRate" value="12" min="1" max="100">
                            </div>
                            
                            <!-- SIP Inputs -->
                            <div class="investment-type">
                                <h3>SIP Details</h3>
                                <div class="input-group">
                                    <label for="sipAmount">Monthly Investment (â‚¹)</label>
                                    <input type="number" id="sipAmount" placeholder="e.g., 10000">
                                </div>
                                <div class="date-inputs">
                                    <div class="input-group">
                                        <label for="sipStart">Start Date</label>
                                        <input type="date" id="sipStart">
                                    </div>
                                    <div class="input-group">
                                        <label for="sipEnd">End Date</label>
                                        <input type="date" id="sipEnd">
                                    </div>
                                </div>
                            </div>

                            <!-- Lumpsum Section -->
                            <div class="investment-type">
                                <h3>Lumpsum Investments</h3>
                                <div id="lumpsumContainer">
                                    <!-- Dynamic lumpsum entries will be added here -->
                                </div>
                                <button class="add-btn" onclick="addLumpsumEntry()">+ Add Lumpsum Investment</button>
                            </div>

                            <!-- EMI Calculator Section -->
                            <div class="investment-type">
                                <h3>EMI Calculator</h3>
                                <div class="input-group">
                                    <label for="emiPrincipal">Loan Amount (â‚¹)</label>
                                    <input type="number" id="emiPrincipal" placeholder="e.g., 1000000">
                                </div>
                                <div class="input-group">
                                    <label for="emiRate">Annual Interest Rate (%)</label>
                                    <input type="number" id="emiRate" placeholder="e.g., 8.5" step="0.1">
                                </div>
                                <div class="input-group">
                                    <label for="emiTenure">Loan Tenure (Years)</label>
                                    <input type="number" id="emiTenure" placeholder="e.g., 20">
                                </div>
                                <div class="emi-result">
                                    <h4>Monthly EMI</h4>
                                    <p id="monthlyEMI">â‚¹0</p>
                                </div>
                                <div class="emi-breakdown">
                                    <div class="summary-item">
                                        <h4>Total Interest</h4>
                                        <p id="totalInterest">â‚¹0</p>
                                    </div>
                                    <div class="summary-item">
                                        <h4>Total Payment</h4>
                                        <p id="totalPayment">â‚¹0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- SWP Section -->
                            <div class="investment-type">
                                <h3>SWP Details</h3>
                                <div class="recommendation-note">
                                    <p><strong>ðŸ’¡ Recommendation:</strong> International best practice suggests a 4% annual withdrawal rate for sustainable retirement income.</p>
                                </div>
                                <div class="input-group">
                                    <label for="swpAmount">Monthly Withdrawal (â‚¹)</label>
                                    <input type="number" id="swpAmount" placeholder="e.g., 5000">
                                </div>
                                <div class="input-group">
                                    <label for="swpCorpus">Total Corpus for SWP (â‚¹)</label>
                                    <input type="number" id="swpCorpus" placeholder="e.g., 1500000">
                                    <button type="button" class="recommendation-btn" onclick="applySWPRecommendation()">Apply 4% Rule</button>
                                </div>
                                <div class="date-inputs">
                                    <div class="input-group">
                                        <label for="swpStart">Start Date</label>
                                        <input type="date" id="swpStart">
                                    </div>
                                    <div class="input-group">
                                        <label for="swpEnd">End Date</label>
                                        <input type="date" id="swpEnd">
                                    </div>
                                </div>
                            </div>

                            <!-- Post-Investment Withdrawal Plan -->
                            <div class="investment-type">
                                <h3>Post-Investment Withdrawal Plan</h3>
                                <div class="input-group">
                                    <label>Withdrawal Type</label>
                                    <select id="postWithdrawalType" class="custom-select">
                                        <option value="monthly">Monthly Withdrawal</option>
                                        <option value="yearly">Yearly Withdrawal</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="postWithdrawalAmount">Withdrawal Amount (â‚¹)</label>
                                    <input type="number" id="postWithdrawalAmount" placeholder="e.g., 50000">
                                </div>
                                <div class="date-inputs">
                                    <div class="input-group">
                                        <label for="postWithdrawalStart">Start Date</label>
                                        <input type="date" id="postWithdrawalStart">
                                    </div>
                                    <div class="input-group">
                                        <label for="postWithdrawalEnd">End Date</label>
                                        <input type="date" id="postWithdrawalEnd">
                                    </div>
                                </div>
                                <div class="final-balance">
                                    <h4>Projected Final Balance</h4>
                                    <p id="finalBalance">â‚¹0</p>
                                </div>
                            </div>

                            <button class="calculate-btn" onclick="calculateInvestment()">Calculate Returns</button>
                        </div>
                    </section>

                    <!-- Results Section -->
                    <section class="results-section">
                        <div class="card">
                            <h2>Investment Summary</h2>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <h4>Total Invested</h4>
                                    <p id="totalInvested">â‚¹0</p>
                                </div>
                                <div class="summary-item">
                                    <h4>Expected Returns</h4>
                                    <p id="totalReturns">â‚¹0</p>
                                </div>
                                <div class="summary-item">
                                    <h4>Total Withdrawals</h4>
                                    <p id="totalWithdrawals">â‚¹0</p>
                                </div>
                                <div class="summary-item">
                                    <h4>Net Gain/Loss</h4>
                                    <p id="netGainLoss">â‚¹0</p>
                                </div>
                            </div>

                            <div class="chart-container">
                                <canvas id="investmentChart"></canvas>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Advanced Calculations Tab -->
            <div id="advanced" class="tab-content">
                <div class="calc-grid">
                    <!-- CAGR Calculator -->
                    <div class="calc-card">
                        <h3>CAGR Calculator</h3>
                        <div class="input-group">
                            <label for="cagrStartValue">Initial Value (â‚¹)</label>
                            <input type="number" id="cagrStartValue" placeholder="e.g., 100000">
                        </div>
                        <div class="input-group">
                            <label for="cagrEndValue">Final Value (â‚¹)</label>
                            <input type="number" id="cagrEndValue" placeholder="e.g., 200000">
                        </div>
                        <div class="input-group">
                            <label for="cagrYears">Investment Period (Years)</label>
                            <input type="number" id="cagrYears" placeholder="e.g., 5" step="0.1">
                        </div>
                        <button class="calculate-btn" onclick="calculateCAGR()">Calculate CAGR</button>
                        <div class="calc-result">
                            <h4>CAGR</h4>
                            <p id="cagrResult">0%</p>
                        </div>
                    </div>

                    <!-- Present Value Calculator -->
                    <div class="calc-card">
                        <h3>Present Value Calculator</h3>
                        <div class="input-group">
                            <label for="pvFutureValue">Future Value (â‚¹)</label>
                            <input type="number" id="pvFutureValue" placeholder="e.g., 200000">
                        </div>
                        <div class="input-group">
                            <label for="pvRate">Annual Rate (%)</label>
                            <input type="number" id="pvRate" placeholder="e.g., 8" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="pvYears">Years</label>
                            <input type="number" id="pvYears" placeholder="e.g., 10">
                        </div>
                        <button class="calculate-btn" onclick="calculatePV()">Calculate Present Value</button>
                        <div class="calc-result">
                            <h4>Present Value</h4>
                            <p id="pvResult">â‚¹0</p>
                        </div>
                    </div>

                    <!-- ROI Calculator -->
                    <div class="calc-card">
                        <h3>ROI Calculator</h3>
                        <div class="input-group">
                            <label for="roiCost">Initial Investment (â‚¹)</label>
                            <input type="number" id="roiCost" placeholder="e.g., 100000">
                        </div>
                        <div class="input-group">
                            <label for="roiGain">Current Value (â‚¹)</label>
                            <input type="number" id="roiGain" placeholder="e.g., 150000">
                        </div>
                        <button class="calculate-btn" onclick="calculateROI()">Calculate ROI</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>ROI Percentage</h5>
                                <p id="roiPercentage">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>Absolute Gain</h5>
                                <p id="roiAbsolute">â‚¹0</p>
                            </div>
                        </div>
                    </div>

                    <!-- IRR/XIRR Calculator -->
                    <div class="calc-card">
                        <h3>IRR/XIRR Calculator</h3>
                        <div id="cashFlowContainer">
                            <div class="cashflow-input">
                                <input type="date" placeholder="Date" class="cashflow-date">
                                <input type="number" placeholder="Amount (â‚¹)" class="cashflow-amount">
                                <button type="button" class="remove-btn" onclick="removeCashFlow(this)">Ã—</button>
                            </div>
                        </div>
                        <button class="add-asset-btn" onclick="addCashFlow()">+ Add Cash Flow</button>
                        <button class="calculate-btn" onclick="calculateIRR()">Calculate IRR</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>IRR</h5>
                                <p id="irrResult">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>Total Investment</h5>
                                <p id="irrInvestment">â‚¹0</p>
                            </div>
                        </div>
                    </div>

                    <!-- NPV Calculator -->
                    <div class="calc-card">
                        <h3>NPV Calculator</h3>
                        <div class="input-group">
                            <label for="npvRate">Discount Rate (%)</label>
                            <input type="number" id="npvRate" placeholder="e.g., 10" step="0.1">
                        </div>
                        <div id="npvCashFlowContainer">
                            <div class="input-group">
                                <label>Cash Flows (â‚¹)</label>
                                <input type="number" class="npv-cashflow" placeholder="Year 0 (Initial Investment)">
                                <input type="number" class="npv-cashflow" placeholder="Year 1">
                                <input type="number" class="npv-cashflow" placeholder="Year 2">
                                <input type="number" class="npv-cashflow" placeholder="Year 3">
                            </div>
                        </div>
                        <button class="add-asset-btn" onclick="addNPVYear()">+ Add Year</button>
                        <button class="calculate-btn" onclick="calculateNPV()">Calculate NPV</button>
                        <div class="calc-result">
                            <h4>Net Present Value</h4>
                            <p id="npvResult">â‚¹0</p>
                        </div>
                    </div>

                    <!-- Inflation Adjusted Returns -->
                    <div class="calc-card">
                        <h3>Inflation Adjusted Returns</h3>
                        <div class="input-group">
                            <label for="inflationNominal">Nominal Return (%)</label>
                            <input type="number" id="inflationNominal" placeholder="e.g., 12" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="inflationRate">Inflation Rate (%)</label>
                            <input type="number" id="inflationRate" placeholder="e.g., 6" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="taxRate">Tax Rate (%)</label>
                            <input type="number" id="taxRate" placeholder="e.g., 20" step="0.1">
                        </div>
                        <button class="calculate-btn" onclick="calculateInflationAdjusted()">Calculate Real Returns</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>Real Return</h5>
                                <p id="realReturn">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>After-Tax Return</h5>
                                <p id="afterTaxReturn">0%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Analytics Tab -->
            <div id="portfolio" class="tab-content">
                <div class="calc-grid">
                    <!-- Portfolio Optimizer -->
                    <div class="calc-card">
                        <h3>Portfolio Analytics</h3>
                        <div id="portfolioContainer">
                            <div class="portfolio-input">
                                <input type="text" placeholder="Asset Name" class="asset-name">
                                <input type="number" placeholder="Weight %" class="asset-weight">
                                <input type="number" placeholder="Expected Return %" class="asset-return">
                                <input type="number" placeholder="Risk (Std Dev) %" class="asset-risk">
                            </div>
                        </div>
                        <button class="add-asset-btn" onclick="addAsset()">+ Add Asset</button>
                        <button class="calculate-btn" onclick="calculatePortfolio()">Analyze Portfolio</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>Portfolio Return</h5>
                                <p id="portfolioReturn">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>Portfolio Risk</h5>
                                <p id="portfolioRisk">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>Sharpe Ratio</h5>
                                <p id="sharpeRatio">0</p>
                            </div>
                            <div class="result-item">
                                <h5>Risk-Return Ratio</h5>
                                <p id="riskReturnRatio">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bond Calculator -->
                    <div class="calc-card">
                        <h3>Bond Calculator</h3>
                        <div class="input-group">
                            <label for="bondFaceValue">Face Value (â‚¹)</label>
                            <input type="number" id="bondFaceValue" placeholder="e.g., 1000">
                        </div>
                        <div class="input-group">
                            <label for="bondCouponRate">Coupon Rate (%)</label>
                            <input type="number" id="bondCouponRate" placeholder="e.g., 8" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="bondYield">Market Yield (%)</label>
                            <input type="number" id="bondYield" placeholder="e.g., 7.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="bondMaturity">Years to Maturity</label>
                            <input type="number" id="bondMaturity" placeholder="e.g., 10">
                        </div>
                        <button class="calculate-btn" onclick="calculateBond()">Calculate Bond Metrics</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>Current Price</h5>
                                <p id="bondPrice">â‚¹0</p>
                            </div>
                            <div class="result-item">
                                <h5>Duration</h5>
                                <p id="bondDuration">0 years</p>
                            </div>
                            <div class="result-item">
                                <h5>YTM</h5>
                                <p id="bondYTM">0%</p>
                            </div>
                            <div class="result-item">
                                <h5>Annual Coupon</h5>
                                <p id="bondCoupon">â‚¹0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Analysis Tab -->
            <div id="risk" class="tab-content">
                <div class="calc-grid">
                    <!-- Monte Carlo Simulation -->
                    <div class="calc-card">
                        <h3>Monte Carlo Simulation</h3>
                        <div class="input-group">
                            <label for="mcInitial">Initial Investment (â‚¹)</label>
                            <input type="number" id="mcInitial" placeholder="e.g., 100000">
                        </div>
                        <div class="input-group">
                            <label for="mcReturn">Expected Annual Return (%)</label>
                            <input type="number" id="mcReturn" placeholder="e.g., 12" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="mcVolatility">Volatility/Standard Deviation (%)</label>
                            <input type="number" id="mcVolatility" placeholder="e.g., 15" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="mcYears">Investment Period (Years)</label>
                            <input type="number" id="mcYears" placeholder="e.g., 10">
                        </div>
                        <button class="calculate-btn" onclick="runMonteCarloSimulation()">Run Simulation</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>Best Case (95%)</h5>
                                <p id="mc95">â‚¹0</p>
                            </div>
                            <div class="result-item">
                                <h5>Expected (50%)</h5>
                                <p id="mc50">â‚¹0</p>
                            </div>
                            <div class="result-item">
                                <h5>Worst Case (5%)</h5>
                                <p id="mc5">â‚¹0</p>
                            </div>
                            <div class="result-item">
                                <h5>Probability of Loss</h5>
                                <p id="mcLossProbability">0%</p>
                            </div>
                        </div>
                        <div class="advanced-chart">
                            <canvas id="monteCarloChart"></canvas>
                        </div>
                    </div>

                    <!-- VaR Calculator -->
                    <div class="calc-card">
                        <h3>Value at Risk (VaR)</h3>
                        <div class="input-group">
                            <label for="varPortfolioValue">Portfolio Value (â‚¹)</label>
                            <input type="number" id="varPortfolioValue" placeholder="e.g., 1000000">
                        </div>
                        <div class="input-group">
                            <label for="varVolatility">Annual Volatility (%)</label>
                            <input type="number" id="varVolatility" placeholder="e.g., 20" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="varConfidence">Confidence Level (%)</label>
                            <select id="varConfidence" class="custom-select">
                                <option value="95">95%</option>
                                <option value="99">99%</option>
                                <option value="99.9">99.9%</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="varTimeHorizon">Time Horizon (Days)</label>
                            <input type="number" id="varTimeHorizon" value="1" placeholder="e.g., 1">
                        </div>
                        <button class="calculate-btn" onclick="calculateVaR()">Calculate VaR</button>
                        <div class="result-grid">
                            <div class="result-item">
                                <h5>Daily VaR</h5>
                                <p id="varDaily">â‚¹0</p>
                            </div>
                            <div class="result-item">
                                <h5>VaR Percentage</h5>
                                <p id="varPercentage">0%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        class InvestmentCalculator {
            constructor() {
                this.investments = [];
                this.annualRate = 0;
                this.chart = null;
            }

            // Set annual interest rate
            setAnnualRate(rate) {
                this.annualRate = rate;
            }

            // Add SIP investment
            addSIP(monthlyAmount, startDate, endDate) {
                this.investments.push({
                    type: 'SIP',
                    amount: monthlyAmount,
                    startDate: new Date(startDate),
                    endDate: new Date(endDate)
                });
            }

            // Add Lumpsum investment
            addLumpsum(amount, date) {
                this.investments.push({
                    type: 'LUMPSUM',
                    amount: amount,
                    date: new Date(date)
                });
            }

            // Add SWP (withdrawal)
            addSWP(monthlyWithdrawal, startDate, endDate) {
                this.investments.push({
                    type: 'SWP',
                    amount: -monthlyWithdrawal, // Negative amount for withdrawals
                    startDate: new Date(startDate),
                    endDate: new Date(endDate)
                });
            }

            // Add Post-Investment Withdrawal
            addPostWithdrawal(amount, type, startDate, endDate) {
                this.investments.push({
                    type: 'POST_WITHDRAWAL',
                    amount: -amount,
                    withdrawalType: type,
                    startDate: new Date(startDate),
                    endDate: new Date(endDate)
                });
            }

            // Helper function to calculate months between dates
            monthsDifference(startDate, endDate) {
                return (endDate.getFullYear() - startDate.getFullYear()) * 12 + 
                       endDate.getMonth() - startDate.getMonth();
            }

            // Calculate returns up to a specific date
            calculateReturns(targetDate) {
                let total = 0;
                const monthlyRate = this.annualRate / 12 / 100;

                this.investments.forEach(investment => {
                    if (investment.type === 'LUMPSUM') {
                        if (investment.date <= targetDate) {
                            const months = this.monthsDifference(investment.date, targetDate);
                            total += investment.amount * Math.pow(1 + monthlyRate, months);
                        }
                    } else {
                        // For SIP and SWP
                        let currentDate = new Date(investment.startDate);
                        while (currentDate <= targetDate && currentDate <= investment.endDate) {
                            const months = this.monthsDifference(currentDate, targetDate);
                            total += investment.amount * Math.pow(1 + monthlyRate, months);
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        }
                    }
                });

                return Math.round(total);
            }

            // Calculate final balance including post-investment withdrawals
            calculateFinalBalance(targetDate) {
                let balance = this.calculateReturns(targetDate);
                const monthlyRate = this.annualRate / 12 / 100;

                this.investments
                    .filter(inv => inv.type === 'POST_WITHDRAWAL')
                    .forEach(withdrawal => {
                        if (withdrawal.withdrawalType === 'yearly') {
                            const years = Math.floor(
                                (withdrawal.endDate - withdrawal.startDate) / (365 * 24 * 60 * 60 * 1000)
                            );
                            balance += withdrawal.amount * 12 * years;
                        } else {
                            const months = this.monthsDifference(withdrawal.startDate, withdrawal.endDate);
                            balance += withdrawal.amount * months;
                        }
                    });

                return Math.round(balance);
            }

            // Get detailed investment summary
            getSummary(finalDate) {
                const summary = {
                    totalInvested: 0,
                    totalReturns: this.calculateReturns(finalDate),
                    sipTotal: 0,
                    lumpsumTotal: 0,
                    swpTotal: 0,
                    gainLoss: 0
                };

                this.investments.forEach(investment => {
                    if (investment.type === 'LUMPSUM') {
                        summary.lumpsumTotal += investment.amount;
                    } else {
                        const months = this.monthsDifference(
                            investment.startDate, 
                            new Date(Math.min(finalDate, investment.endDate))
                        );
                        const totalAmount = investment.amount * (months + 1);
                        if (investment.type === 'SIP') {
                            summary.sipTotal += totalAmount;
                        } else {
                            summary.swpTotal += Math.abs(totalAmount);
                        }
                    }
                });

                summary.totalInvested = summary.sipTotal + summary.lumpsumTotal;
                summary.gainLoss = summary.totalReturns - summary.totalInvested + summary.swpTotal;

                return summary;
            }

            // Update the generateChartData method in InvestmentCalculator class
            generateChartData(startDate, endDate) {
                const dates = [];
                const balances = [];
                let currentDate = new Date(startDate);

                // Ensure we create a fresh date object to avoid reference issues
                endDate = new Date(endDate);

                while (currentDate <= endDate) {
                    // Create a fresh date object for calculations
                    const calculationDate = new Date(currentDate);
                    dates.push(calculationDate.toLocaleDateString('en-GB', { 
                        month: 'short', 
                        year: 'numeric' 
                    }));
                    
                    const balance = this.calculateReturns(calculationDate);
                    balances.push(balance);

                    // Move to next month
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }

                return { dates, balances };
            }

            // Update chart
            updateChart(startDate, endDate) {
                const ctx = document.getElementById('investmentChart').getContext('2d');
                const { dates, balances } = this.generateChartData(startDate, endDate);

                if (this.chart) {
                    this.chart.destroy();
                }

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Investment Value',
                            data: balances,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 750
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'â‚¹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'â‚¹' + value.toLocaleString('en-IN')
                                }
                            }
                        }
                    }
                });
            }

            // Validate inputs
            validateInputs() {
                const errors = [];
                
                if (this.annualRate <= 0 || this.annualRate > 100) {
                    errors.push('Annual rate must be between 0 and 100%');
                }
                
                this.investments.forEach((inv, index) => {
                    // Skip validation for empty investments
                    if (!inv.amount && inv.amount !== 0) {
                        return;
                    }

                    // For SWP, amount is already negative, so check absolute value
                    const amountToCheck = inv.type === 'SWP' ? Math.abs(inv.amount) : inv.amount;
                    
                    if (amountToCheck <= 0) {
                        errors.push(`${inv.type === 'SWP' ? 'Withdrawal' : 'Investment'} amount must be positive`);
                    }

                    // Only check dates for SIP and SWP
                    if (inv.type !== 'LUMPSUM') {
                        if (!inv.startDate || !inv.endDate) {
                            errors.push(`Please set both start and end dates for ${inv.type}`);
                        } else if (inv.startDate >= inv.endDate) {
                            errors.push(`End date must be after start date for ${inv.type}`);
                        }
                    }
                });
                
                return errors;
            }
        }

        // UI Helper Functions
        function addLumpsumEntry() {
            const container = document.getElementById('lumpsumContainer');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'lumpsum-entry';
            entryDiv.innerHTML = `
                <button class="remove-investment" onclick="removeInvestment(this)">&times;</button>
                <div class="input-group">
                    <label>Amount (â‚¹)</label>
                    <input type="number" class="lumpsum-amount" placeholder="e.g., 20000" onchange="calculateInvestment()">
                </div>
                <div class="input-group">
                    <label>Investment Date</label>
                    <input type="date" class="lumpsum-date" onchange="calculateInvestment()">
                </div>
            `;
            container.appendChild(entryDiv);
        }

        function removeInvestment(button) {
            button.parentElement.remove();
            calculateInvestment();
        }

        // Update all input elements to recalculate on change
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    calculateInvestment();
                    calculateEMI();
                });
            });
        });

        // EMI Calculator Functions
        function calculateEMI() {
            const principal = parseFloat(document.getElementById('emiPrincipal').value) || 0;
            const annualRate = parseFloat(document.getElementById('emiRate').value) || 0;
            const tenure = parseFloat(document.getElementById('emiTenure').value) || 0;

            if (principal > 0 && annualRate > 0 && tenure > 0) {
                const monthlyRate = annualRate / 12 / 100;
                const numberOfPayments = tenure * 12;
                
                // EMI formula: P * r * (1 + r)^n / ((1 + r)^n - 1)
                const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments) / 
                           (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                
                const totalPayment = emi * numberOfPayments;
                const totalInterest = totalPayment - principal;

                document.getElementById('monthlyEMI').textContent = 'â‚¹' + Math.round(emi).toLocaleString('en-IN');
                document.getElementById('totalInterest').textContent = 'â‚¹' + Math.round(totalInterest).toLocaleString('en-IN');
                document.getElementById('totalPayment').textContent = 'â‚¹' + Math.round(totalPayment).toLocaleString('en-IN');
            } else {
                document.getElementById('monthlyEMI').textContent = 'â‚¹0';
                document.getElementById('totalInterest').textContent = 'â‚¹0';
                document.getElementById('totalPayment').textContent = 'â‚¹0';
            }
        }

        // SWP 4% Rule Recommendation
        function applySWPRecommendation() {
            const corpus = parseFloat(document.getElementById('swpCorpus').value) || 0;
            if (corpus > 0) {
                // 4% annual withdrawal = 4% / 12 months
                const monthlyWithdrawal = (corpus * 0.04) / 12;
                document.getElementById('swpAmount').value = Math.round(monthlyWithdrawal);
                calculateInvestment();
            } else {
                alert('Please enter the total corpus amount first.');
            }
        }

        // Update calculateInvestment function
        function calculateInvestment() {
            const calculator = new InvestmentCalculator();
            const annualRate = parseFloat(document.getElementById('annualRate').value) || 0;
            calculator.setAnnualRate(annualRate);

            let hasInvestments = false;
            let earliestDate = null;
            let latestDate = null;

            // Add SIP if values are present
            const sipAmount = parseFloat(document.getElementById('sipAmount').value);
            const sipStart = document.getElementById('sipStart').value;
            const sipEnd = document.getElementById('sipEnd').value;
            if (sipAmount > 0 && sipStart && sipEnd) {
                calculator.addSIP(sipAmount, sipStart, sipEnd);
                earliestDate = new Date(sipStart);
                latestDate = new Date(sipEnd);
                hasInvestments = true;
            }

            // Add Lumpsums
            document.querySelectorAll('.lumpsum-entry').forEach(entry => {
                const amount = parseFloat(entry.querySelector('.lumpsum-amount').value);
                const date = entry.querySelector('.lumpsum-date').value;
                if (amount > 0 && date) {
                    calculator.addLumpsum(amount, date);
                    const investDate = new Date(date);
                    earliestDate = earliestDate ? new Date(Math.min(investDate, earliestDate)) : investDate;
                    latestDate = latestDate ? new Date(Math.max(investDate, latestDate)) : investDate;
                    hasInvestments = true;
                }
            });

            // Add SWP if values are present
            const swpAmount = parseFloat(document.getElementById('swpAmount').value);
            const swpStart = document.getElementById('swpStart').value;
            const swpEnd = document.getElementById('swpEnd').value;
            if (swpAmount > 0 && swpStart && swpEnd) {
                calculator.addSWP(swpAmount, swpStart, swpEnd);
                latestDate = new Date(Math.max(new Date(swpEnd), latestDate));
            }

            // Add post-investment withdrawal
            const postWithdrawalAmount = parseFloat(document.getElementById('postWithdrawalAmount').value);
            const postWithdrawalType = document.getElementById('postWithdrawalType').value;
            const postWithdrawalStart = document.getElementById('postWithdrawalStart').value;
            const postWithdrawalEnd = document.getElementById('postWithdrawalEnd').value;

            if (postWithdrawalAmount > 0 && postWithdrawalStart && postWithdrawalEnd) {
                calculator.addPostWithdrawal(
                    postWithdrawalAmount,
                    postWithdrawalType,
                    postWithdrawalStart,
                    postWithdrawalEnd
                );
                latestDate = new Date(Math.max(new Date(postWithdrawalEnd), latestDate || 0));
            }

            // Only validate if we have investments
            if (hasInvestments) {
                const errors = calculator.validateInputs();
                if (errors.length > 0) {
                    showErrors(errors);
                    return;
                }

                const summary = calculator.getSummary(latestDate);
                const finalBalance = calculator.calculateFinalBalance(latestDate);

                // Update summary values
                document.getElementById('totalInvested').textContent = 
                    'â‚¹' + summary.totalInvested.toLocaleString('en-IN');
                document.getElementById('totalReturns').textContent = 
                    'â‚¹' + summary.totalReturns.toLocaleString('en-IN');
                document.getElementById('totalWithdrawals').textContent = 
                    'â‚¹' + summary.swpTotal.toLocaleString('en-IN');
                document.getElementById('netGainLoss').textContent = 
                    'â‚¹' + summary.gainLoss.toLocaleString('en-IN');

                // Update final balance
                document.getElementById('finalBalance').textContent = 
                    'â‚¹' + finalBalance.toLocaleString('en-IN');

                // Update chart with extended timeline
                calculator.updateChart(earliestDate, latestDate);
            } else {
                showErrors(['Please add at least one investment']);
            }
        }

        function showErrors(errors) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h4>Please fix the following errors:</h4>
                <ul>
                    ${errors.map(err => `<li>${err}</li>`).join('')}
                </ul>
            `;
            
            document.querySelector('.input-section .card').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Tab Navigation Functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Advanced Calculator Functions
        function calculateCAGR() {
            const startValue = parseFloat(document.getElementById('cagrStartValue').value) || 0;
            const endValue = parseFloat(document.getElementById('cagrEndValue').value) || 0;
            const years = parseFloat(document.getElementById('cagrYears').value) || 0;

            if (startValue > 0 && endValue > 0 && years > 0) {
                const cagr = (Math.pow(endValue / startValue, 1 / years) - 1) * 100;
                document.getElementById('cagrResult').textContent = cagr.toFixed(2) + '%';
            } else {
                document.getElementById('cagrResult').textContent = '0%';
            }
        }

        function calculatePV() {
            const futureValue = parseFloat(document.getElementById('pvFutureValue').value) || 0;
            const rate = parseFloat(document.getElementById('pvRate').value) || 0;
            const years = parseFloat(document.getElementById('pvYears').value) || 0;

            if (futureValue > 0 && rate > 0 && years > 0) {
                const presentValue = futureValue / Math.pow(1 + rate / 100, years);
                document.getElementById('pvResult').textContent = 'â‚¹' + Math.round(presentValue).toLocaleString('en-IN');
            } else {
                document.getElementById('pvResult').textContent = 'â‚¹0';
            }
        }

        function calculateROI() {
            const cost = parseFloat(document.getElementById('roiCost').value) || 0;
            const gain = parseFloat(document.getElementById('roiGain').value) || 0;

            if (cost > 0 && gain > 0) {
                const roi = ((gain - cost) / cost) * 100;
                const absoluteGain = gain - cost;
                
                document.getElementById('roiPercentage').textContent = roi.toFixed(2) + '%';
                document.getElementById('roiAbsolute').textContent = 'â‚¹' + Math.round(absoluteGain).toLocaleString('en-IN');
            } else {
                document.getElementById('roiPercentage').textContent = '0%';
                document.getElementById('roiAbsolute').textContent = 'â‚¹0';
            }
        }

        function addCashFlow() {
            const container = document.getElementById('cashFlowContainer');
            const div = document.createElement('div');
            div.className = 'cashflow-input';
            div.innerHTML = `
                <input type="date" placeholder="Date" class="cashflow-date">
                <input type="number" placeholder="Amount (â‚¹)" class="cashflow-amount">
                <button type="button" class="remove-btn" onclick="removeCashFlow(this)">Ã—</button>
            `;
            container.appendChild(div);
        }

        function removeCashFlow(button) {
            button.parentElement.remove();
        }

        function calculateIRR() {
            const cashFlows = [];
            const amounts = document.querySelectorAll('.cashflow-amount');
            let totalInvestment = 0;

            amounts.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (amount !== 0) {
                    cashFlows.push(amount);
                    if (amount < 0) totalInvestment += Math.abs(amount);
                }
            });

            if (cashFlows.length >= 2) {
                // Simplified IRR calculation using Newton-Raphson method
                const irr = calculateIRRValue(cashFlows);
                document.getElementById('irrResult').textContent = (irr * 100).toFixed(2) + '%';
                document.getElementById('irrInvestment').textContent = 'â‚¹' + totalInvestment.toLocaleString('en-IN');
            } else {
                document.getElementById('irrResult').textContent = '0%';
                document.getElementById('irrInvestment').textContent = 'â‚¹0';
            }
        }

        function calculateIRRValue(cashFlows) {
            // Simplified IRR calculation
            let rate = 0.1; // Initial guess
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dnpv = 0;

                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + rate, j);
                    dnpv -= j * cashFlows[j] / Math.pow(1 + rate, j + 1);
                }

                const newRate = rate - npv / dnpv;
                if (Math.abs(newRate - rate) < tolerance) {
                    return newRate;
                }
                rate = newRate;
            }
            return rate;
        }

        function addNPVYear() {
            const container = document.getElementById('npvCashFlowContainer').querySelector('.input-group');
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'npv-cashflow';
            input.placeholder = `Year ${container.children.length}`;
            container.appendChild(input);
        }

        function calculateNPV() {
            const rate = parseFloat(document.getElementById('npvRate').value) || 0;
            const cashFlows = Array.from(document.querySelectorAll('.npv-cashflow')).map(input => parseFloat(input.value) || 0);

            if (rate > 0 && cashFlows.some(cf => cf !== 0)) {
                let npv = 0;
                cashFlows.forEach((cashFlow, index) => {
                    npv += cashFlow / Math.pow(1 + rate / 100, index);
                });

                document.getElementById('npvResult').textContent = 'â‚¹' + Math.round(npv).toLocaleString('en-IN');
            } else {
                document.getElementById('npvResult').textContent = 'â‚¹0';
            }
        }

        function calculateInflationAdjusted() {
            const nominal = parseFloat(document.getElementById('inflationNominal').value) || 0;
            const inflation = parseFloat(document.getElementById('inflationRate').value) || 0;
            const tax = parseFloat(document.getElementById('taxRate').value) || 0;

            if (nominal > 0 && inflation >= 0) {
                const realReturn = ((1 + nominal / 100) / (1 + inflation / 100) - 1) * 100;
                const afterTaxReturn = nominal * (1 - tax / 100);

                document.getElementById('realReturn').textContent = realReturn.toFixed(2) + '%';
                document.getElementById('afterTaxReturn').textContent = afterTaxReturn.toFixed(2) + '%';
            } else {
                document.getElementById('realReturn').textContent = '0%';
                document.getElementById('afterTaxReturn').textContent = '0%';
            }
        }

        // Portfolio Analytics Functions
        function addAsset() {
            const container = document.getElementById('portfolioContainer');
            const div = document.createElement('div');
            div.className = 'portfolio-input';
            div.innerHTML = `
                <input type="text" placeholder="Asset Name" class="asset-name">
                <input type="number" placeholder="Weight %" class="asset-weight">
                <input type="number" placeholder="Expected Return %" class="asset-return">
                <input type="number" placeholder="Risk (Std Dev) %" class="asset-risk">
            `;
            container.appendChild(div);
        }

        function calculatePortfolio() {
            const assets = Array.from(document.querySelectorAll('.portfolio-input')).map(row => ({
                weight: parseFloat(row.querySelector('.asset-weight').value) || 0,
                return: parseFloat(row.querySelector('.asset-return').value) || 0,
                risk: parseFloat(row.querySelector('.asset-risk').value) || 0
            })).filter(asset => asset.weight > 0);

            if (assets.length > 0) {
                const totalWeight = assets.reduce((sum, asset) => sum + asset.weight, 0);
                
                // Portfolio expected return
                const portfolioReturn = assets.reduce((sum, asset) => sum + (asset.weight / totalWeight) * asset.return, 0);
                
                // Portfolio risk (simplified calculation)
                const portfolioRisk = Math.sqrt(assets.reduce((sum, asset) => sum + Math.pow((asset.weight / totalWeight) * asset.risk, 2), 0));
                
                // Sharpe ratio (assuming risk-free rate of 6%)
                const riskFreeRate = 6;
                const sharpeRatio = (portfolioReturn - riskFreeRate) / portfolioRisk;
                
                const riskReturnRatio = portfolioReturn / portfolioRisk;

                document.getElementById('portfolioReturn').textContent = portfolioReturn.toFixed(2) + '%';
                document.getElementById('portfolioRisk').textContent = portfolioRisk.toFixed(2) + '%';
                document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);
                document.getElementById('riskReturnRatio').textContent = riskReturnRatio.toFixed(2);
            }
        }

        // Bond Calculator Functions
        function calculateBond() {
            const faceValue = parseFloat(document.getElementById('bondFaceValue').value) || 0;
            const couponRate = parseFloat(document.getElementById('bondCouponRate').value) || 0;
            const marketYield = parseFloat(document.getElementById('bondYield').value) || 0;
            const maturity = parseFloat(document.getElementById('bondMaturity').value) || 0;

            if (faceValue > 0 && couponRate >= 0 && marketYield > 0 && maturity > 0) {
                const annualCoupon = (faceValue * couponRate) / 100;
                
                // Bond price calculation
                let bondPrice = 0;
                for (let i = 1; i <= maturity; i++) {
                    bondPrice += annualCoupon / Math.pow(1 + marketYield / 100, i);
                }
                bondPrice += faceValue / Math.pow(1 + marketYield / 100, maturity);
                
                // Duration calculation (simplified Macaulay duration)
                let duration = 0;
                let totalPV = 0;
                for (let i = 1; i <= maturity; i++) {
                    const pv = annualCoupon / Math.pow(1 + marketYield / 100, i);
                    duration += i * pv;
                    totalPV += pv;
                }
                const finalPV = faceValue / Math.pow(1 + marketYield / 100, maturity);
                duration += maturity * finalPV;
                totalPV += finalPV;
                duration = duration / totalPV;

                document.getElementById('bondPrice').textContent = 'â‚¹' + Math.round(bondPrice).toLocaleString('en-IN');
                document.getElementById('bondDuration').textContent = duration.toFixed(2) + ' years';
                document.getElementById('bondYTM').textContent = marketYield.toFixed(2) + '%';
                document.getElementById('bondCoupon').textContent = 'â‚¹' + Math.round(annualCoupon).toLocaleString('en-IN');
            }
        }

        // Risk Analysis Functions
        function runMonteCarloSimulation() {
            const initial = parseFloat(document.getElementById('mcInitial').value) || 0;
            const expectedReturn = parseFloat(document.getElementById('mcReturn').value) || 0;
            const volatility = parseFloat(document.getElementById('mcVolatility').value) || 0;
            const years = parseFloat(document.getElementById('mcYears').value) || 0;

            if (initial > 0 && expectedReturn > 0 && volatility > 0 && years > 0) {
                const numSimulations = 1000;
                const results = [];

                for (let i = 0; i < numSimulations; i++) {
                    let value = initial;
                    for (let year = 0; year < years; year++) {
                        const randomReturn = normalRandom() * (volatility / 100) + (expectedReturn / 100);
                        value *= (1 + randomReturn);
                    }
                    results.push(value);
                }

                results.sort((a, b) => a - b);
                
                const percentile5 = results[Math.floor(numSimulations * 0.05)];
                const percentile50 = results[Math.floor(numSimulations * 0.5)];
                const percentile95 = results[Math.floor(numSimulations * 0.95)];
                const lossCount = results.filter(r => r < initial).length;
                const lossProbability = (lossCount / numSimulations) * 100;

                document.getElementById('mc5').textContent = 'â‚¹' + Math.round(percentile5).toLocaleString('en-IN');
                document.getElementById('mc50').textContent = 'â‚¹' + Math.round(percentile50).toLocaleString('en-IN');
                document.getElementById('mc95').textContent = 'â‚¹' + Math.round(percentile95).toLocaleString('en-IN');
                document.getElementById('mcLossProbability').textContent = lossProbability.toFixed(1) + '%';

                // Create Monte Carlo chart
                createMonteCarloChart(results, initial);
            }
        }

        function normalRandom() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function createMonteCarloChart(results, initial) {
            const ctx = document.getElementById('monteCarloChart').getContext('2d');
            
            // Create histogram data
            const bins = 20;
            const min = Math.min(...results);
            const max = Math.max(...results);
            const binSize = (max - min) / bins;
            const histogram = new Array(bins).fill(0);
            
            results.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binSize), bins - 1);
                histogram[binIndex]++;
            });

            const labels = histogram.map((_, i) => {
                const binStart = min + i * binSize;
                return 'â‚¹' + Math.round(binStart / 1000) + 'K';
            });

            if (window.monteCarloChart) {
                window.monteCarloChart.destroy();
            }

            window.monteCarloChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Portfolio Value'
                            }
                        }
                    }
                }
            });
        }

        function calculateVaR() {
            const portfolioValue = parseFloat(document.getElementById('varPortfolioValue').value) || 0;
            const volatility = parseFloat(document.getElementById('varVolatility').value) || 0;
            const confidence = parseFloat(document.getElementById('varConfidence').value) || 95;
            const timeHorizon = parseFloat(document.getElementById('varTimeHorizon').value) || 1;

            if (portfolioValue > 0 && volatility > 0) {
                // Z-scores for different confidence levels
                const zScores = {
                    95: 1.645,
                    99: 2.326,
                    99.9: 3.090
                };

                const dailyVolatility = volatility / Math.sqrt(252); // Convert annual to daily
                const adjustedVolatility = dailyVolatility * Math.sqrt(timeHorizon);
                const zScore = zScores[confidence] || 1.645;
                
                const varAmount = portfolioValue * adjustedVolatility * zScore / 100;
                const varPercentage = (varAmount / portfolioValue) * 100;

                document.getElementById('varDaily').textContent = 'â‚¹' + Math.round(varAmount).toLocaleString('en-IN');
                document.getElementById('varPercentage').textContent = varPercentage.toFixed(2) + '%';
            } else {
                document.getElementById('varDaily').textContent = 'â‚¹0';
                document.getElementById('varPercentage').textContent = '0%';
            }
        }

        // Initialize advanced calculators on input change
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for advanced calculator inputs
            const advancedInputs = document.querySelectorAll('#advanced input, #portfolio input, #risk input');
            advancedInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Auto-calculate for certain calculators
                    if (input.closest('.calc-card')?.querySelector('h3')?.textContent === 'CAGR Calculator') {
                        calculateCAGR();
                    } else if (input.closest('.calc-card')?.querySelector('h3')?.textContent === 'Present Value Calculator') {
                        calculatePV();
                    } else if (input.closest('.calc-card')?.querySelector('h3')?.textContent === 'ROI Calculator') {
                        calculateROI();
                    } else if (input.closest('.calc-card')?.querySelector('h3')?.textContent === 'Inflation Adjusted Returns') {
                        calculateInflationAdjusted();
                    }
                });
            });
        });
    </script>
</body>
</html>
